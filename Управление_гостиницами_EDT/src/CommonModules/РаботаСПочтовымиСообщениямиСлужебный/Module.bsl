
Процедура ДобавитьПолеЗапроса(Выражение,Псевдоним,ПоляЗапроса,Колонки)
	ПоляЗапроса.Добавить(Выражение);
	ТекКолонка = Колонки.Получить(ПоляЗапроса.Количество()-1);
	ТекКолонка.Псевдоним = Псевдоним;
КонецПроцедуры


Процедура ДобавитьПоляЗапроса(ПоляЗапроса,Колонки,Протокол)
	ДобавитьПолеЗапроса("УчетныеЗаписиЭлектроннойПочты.СерверВходящейПочты","АдресСервера" + Протокол,ПоляЗапроса,Колонки);
	ДобавитьПолеЗапроса("УчетныеЗаписиЭлектроннойПочты.ЗащищенноеСоединениеДляВходящейПочты","Порт" + Протокол,ПоляЗапроса,Колонки);
	ДобавитьПолеЗапроса("УчетныеЗаписиЭлектроннойПочты.Пользователь","ИспользоватьSSL" + Протокол,ПоляЗапроса,Колонки);
	ДобавитьПолеЗапроса("УчетныеЗаписиЭлектроннойПочты.БезопасныйВходНаСерверВходящейПочты","ТолькоЗащищеннаяАутентификация" + Протокол,ПоляЗапроса,Колонки);
	ДобавитьПолеЗапроса("УчетныеЗаписиЭлектроннойПочты.БезопасныйВходНаСерверВходящейПочты","Пользователь" + ?(Протокол = "POP3","",Протокол),ПоляЗапроса,Колонки);
КонецПроцедуры


Функция ИнтернетПочтовыйПрофиль(УчетнаяЗапись,ВходящаяПочта)

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	УчетныеЗаписиЭлектроннойПочты.СерверВходящейПочты КАК АдресСервераIMAP,
		|	УчетныеЗаписиЭлектроннойПочты.ПортСервераВходящейПочты КАК ПортIMAP,
		|	УчетныеЗаписиЭлектроннойПочты.ЗащищенноеСоединениеДляВходящейПочты КАК ИспользоватьSSLIMAP,
		|	УчетныеЗаписиЭлектроннойПочты.Пользователь КАК ПользовательIMAP,
		|	УчетныеЗаписиЭлектроннойПочты.БезопасныйВходНаСерверВходящейПочты КАК ТолькоЗащищеннаяАутентификацияIMAP,
		|	УчетныеЗаписиЭлектроннойПочты.СерверВходящейПочты КАК АдресСервераPOP3,
		|	УчетныеЗаписиЭлектроннойПочты.ПортСервераВходящейПочты КАК ПортPOP3,
		|	УчетныеЗаписиЭлектроннойПочты.ЗащищенноеСоединениеДляВходящейПочты КАК ИспользоватьSSLPOP3,
		|	УчетныеЗаписиЭлектроннойПочты.Пользователь КАК Пользователь,
		|	УчетныеЗаписиЭлектроннойПочты.БезопасныйВходНаСерверВходящейПочты КАК ТолькоЗащищеннаяАутентификацияPOP3,
		|	УчетныеЗаписиЭлектроннойПочты.СерверИсходящейПочты КАК АдресСервераSMTP,
		|	УчетныеЗаписиЭлектроннойПочты.ПортСервераИсходящейПочты КАК ПортSMTP,
		|	УчетныеЗаписиЭлектроннойПочты.ЗащищенноеСоединениеДляИсходящейПочты КАК ИспользоватьSSLSMTP,
		|	УчетныеЗаписиЭлектроннойПочты.АвторизоватьсяНаСервереПередОтправкой КАК POP3ПередSMTP,
		|	УчетныеЗаписиЭлектроннойПочты.ПользовательСервераОтправки КАК ПользовательSMTP,
		|	УчетныеЗаписиЭлектроннойПочты.БезопасныйВходНаСерверИсходящейПочты КАК ТолькоЗащищеннаяАутентификацияSMTP,
		|	УчетныеЗаписиЭлектроннойПочты.Протокол КАК Протокол,
		|	УчетныеЗаписиЭлектроннойПочты.ВремяОжидания КАК Таймаут
		|ИЗ
		|	Справочник.УчетныеЗаписиЭлектроннойПочты КАК УчетныеЗаписиЭлектроннойПочты
		|ГДЕ
		|	УчетныеЗаписиЭлектроннойПочты.Ссылка = &УчетнаяЗапись";
	
	Запрос.УстановитьПараметр("УчетнаяЗапись", УчетнаяЗапись);
	
	СхемаТест = Новый СхемаЗапроса;
	СхемаТест.УстановитьТекстЗапроса(Запрос.Текст);
	
	УстановитьПривилегированныйРежим(Истина);
	Пароли = ОбщегоНазначения.ПрочитатьДанныеИзБезопасногоХранилища(УчетнаяЗапись, "Пароль,ПарольSMTP");
	УстановитьПривилегированныйРежим(Ложь);
	Результат = Новый ИнтернетПочтовыйПрофиль;
	
	Схема = Новый СхемаЗапроса;
	Пакет = Схема.ПакетЗапросов[0];
	Пакет.ВыбиратьРазрешенные = Истина;
	Оператор = Пакет.Операторы[0];
	Источник = Оператор.Источники.Добавить("Справочник.УчетныеЗаписиЭлектроннойПочты","УчетныеЗаписиЭлектроннойПочты");
	Оператор.Отбор.Добавить("УчетныеЗаписиЭлектроннойПочты.Ссылка = &УчетнаяЗапись");
	Колонки = Пакет.Колонки;
	Если ВходящаяПочта Тогда
		Если УчетнаяЗапись.Протокол = "IMAP" Тогда
			ДобавитьПоляЗапроса(Оператор.ВыбираемыеПоля,Колонки,"IMAP");
			Результат.ПарольIMAP = Пароли.Пароль;
		Иначе
			ДобавитьПоляЗапроса(Оператор.ВыбираемыеПоля,Колонки,"POP3");	
			Результат.Пароль = Пароли.Пароль;
		КонецЕсли; 
		
	Иначе
		
	
	КонецЕсли; 
	
	
	
КонецФункции // ИнтернетПочтовыйПрофиль()

Процедура ПроверитьВозможностьПодключенияКСерверу(Знач УчетнаяЗапись, ВходящаяПочта)
	
	Профиль = ИнтернетПочтовыйПрофиль(УчетнаяЗапись, ВходящаяПочта);
	//Соединение = Новый ИнтернетПочта;
	//
	//Если ВходящаяПочта Тогда
	//	Протокол = ПротоколИнтернетПочты.POP3;
	//	Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(УчетнаяЗапись, "ПротоколВходящейПочты") = "IMAP" Тогда
	//		Протокол = ПротоколИнтернетПочты.IMAP;
	//	КонецЕсли;
	//	Соединение.Подключиться(Профиль, Протокол);
	//Иначе
	//	Соединение.Подключиться(Профиль);
	//КонецЕсли;
	//
	//Соединение.Отключиться();   
	
КонецПроцедуры

Процедура ПроверитьВозможностьОтправкиИПолученияЭлектроннойПочты(УчетнаяЗапись, СообщениеОбОшибке) Экспорт
	
	НастройкиУчетнойЗаписи = Новый Структура("ДляОтправки,ДляПолучения", );
	ЗаполнитьЗначенияСвойств(НастройкиУчетнойЗаписи,УчетнаяЗапись,"ДляОтправки,ДляПолучения");
	
	
	Если НастройкиУчетнойЗаписи.ДляОтправки Тогда
		Попытка
			ПроверитьВозможностьПодключенияКСерверу(УчетнаяЗапись, Ложь);
		Исключение
			СообщениеОбОшибке = "Ошибка в настройках исходящей почты: " + КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		КонецПопытки;
	КонецЕсли;
	
	Если НастройкиУчетнойЗаписи.ДляПолучения Тогда
		Попытка
			ПроверитьВозможностьПодключенияКСерверу(УчетнаяЗапись, Истина);
		Исключение
			Если ЗначениеЗаполнено(СообщениеОбОшибке) Тогда
				СообщениеОбОшибке = СообщениеОбОшибке + Символы.ПС;
			КонецЕсли;
			СообщениеОбОшибке = СообщениеОбОшибке + "Ошибка в настройках входящей почты: " + КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры